language: node_js
matrix:
  fast_finish: true
node_js:
- '14'
branches:
  only:
  - master
  # tags
  - /^\d+\.\d+\.\d+(\-beta.\d+)?$/
env:
  global:
    - MATTERMOST_CHANNEL='{"dev":"feat---password-mgr","beta":"feat---password-mgr,publication","stable":"feat---password-mgr,publication"}'
    # GITHUB_TOKEN for yarn deploy script
    - secure: "mcBVV56jVLzyeJQ3xH32I3QCPLw1dfcP1DVi4hDQtiB9hzvy/qYFTE22q+uo+3R42KQ/kzw5NgPmecHTLpEcaYtSMe8Pgpfckioh8OeISXL7y7Vq5TdfdzfNL1B5zsI3/v6Li3YVxxNdosTzqVz1sJKkKJLFN2wXPNBGtLEpn5hZrv4zB3HvVLt5mhy6+KVuZAn6TrB2xsCfOy6G6+ySpwkbTop/YYkpgj/vfS9YOHcbsRTylHu+phvojASyl3tGRdfAREAv8f28ejBg5MwTkfeusl0a3DsowLIQdxZDuTIbw1cRW4MBx1jVDrfYQ0KocZClPKbfX9/+VNETl8nL5XKq7fDbeqRJ3QmFo1bNkPd9C9+Hw5nQ84XkrygwIK/lXEUTXjW+V608KPk8yVNWiSJ4vwGX2ovxYhvLwCnwoSbxQ2blhWBQseQh6lUwFZ3QL208z3g/VVgXvJmvNE1PCqwVEJwxYIgMr5hul8LSwM9thZo/3vryb/odk9LkHf1TA72LHBrQELdHb3/sJwEZt3bNtyvampRWdM2tc1EI2UAaUJlYzWekYYC7Iz9oMIyXpVJo4sWGCZ8oD39LnVlhYnnQ6F1LFOUswkU1RZhKWMFHsXTeQvSJmXFD1IVk9c0/r45V1SQmYtuCvMEk7kSrpOOOJPOL6DbItzUi0VVRY28="
    # REGISTRY_TOKEN for yarn cozyPublish script
    - secure: "G46H1LRZ9Hrr1aPX7thXars7OA2slyR5MtZGPIc+Togo9YN/C4n5Qy3DNrvqkL/P2bquQuMkeiVFaM1DBwp8pBYJffl9LocqN7s3b+9pLgdlHjYaujhueEwHsq84HjtgQjaEtKVxyVvhlmMVF7pqQsko+CZuowouJXeUEexxwPYaruadkECelbverPirIgKn7bSDZ38r339alJonOLzgtLBR1AnN5c/CBWfs0v596mFJYc+Oa/mmp7kc0mdRDyoqdREmhUf8eAzEy/C5weESFFrizaB5xnDQB8OJgAVelxqs8BU5uVwicrdO5INc2I9WZJUe5aXPkePPBK+doUKAUEYW/LOyWpBmsmDUTjs+fmaGWcKQuIxHFF5cC/glzdsB/J4QSCO57B/Ley0HKK1yAex6SBeR4/abuHdfhTDn6WJxDl/cPWwRY6E3Ckmur8dXQt1ySfvFA/7L+PJ7brlo8U7MHPuAhwrr3FCYNZ/jyFwOkPdAHrOSvFs+35XaNkQxSFiEpGcl0iU2N2bsOJi29jg1xSni+g/BF2QLMxgbQ411hOlK+g6sdaohi3mZESGkuZcDpFuDZ5RMgzHoE/OmDxGyMwL9sbnTm7EURWUpXP99pL1gqqWjzSC6HCQJkHvunShAAmir24PF2wft8NcdVA9YxZj8JlGnujG9nd/BS+M="
    # MATTERMOST_HOOK_URL for yarn cozyPublish script
    - secure: "eHY0FQI3/rY1Q1gQkcNmLJo/LK0IyPyNrcVqbtYbMP7MmHBXAYh10JmKW2A8DbHmIE364J4kkCMYRICpn4lxXcTe2p3zBYy03q4bzwoKUpyTxUI0zjOeHQnGb1AsiP8mO3kAgontXbCl0X29AhmaQotK6jrQV+2ZEQ6jtyqe/ByZGPlsE1xVhOJgbREM2nSAidP3OcBzW7tsEeIciPYqoB9LsiSfzNM5nkfUodxO36gkh05tP3gE6Y8zP4HsbnUUHGafjpLLhRviIrK/DB8aDUzbxHRK7/g2D0FYsM8HYYfO3i/Agegt5/ImY2KM+K0mrn5UVDqFfhkSVjBetdiZCxSzC4rx+ljr9Kxp0deu/02ckapRj9x6PPLTs3BPWZT/h7IxTNYnpOpCIipHRtgyLjqH1ycvrHc+y7h5vOzX6hM/sF14LFp2RWddhQgr+iCXSIg6jK0OVPGdt57pum+hnZH2Yl96oSd8+YJG51KduOYau2iXrTtYu8XoYEdijxyMfzf6hueop/ymsr+3unbRzfrBrOkaYz2Yn+H8thY7VY1ofJoL2Ebmt8kIeRBx6sYcuVvfqOIxJItJxYegUGDFmIq02SMftOhT19MkzMJatVYPuwzP7RhKMkCy+0LCTNxP7RZ0W9Zgo7SRMF+cihkzn0SgtE/oLro/e/DNYsAG/gg="
cache:
  yarn: true
  directories:
  - node_modules
script:
  - npm run lint
  - npm run build:browser:prod
before_install:
  - sudo apt-get install libsecret-1-dev
  - if [ "$TRAVIS_SECURE_ENV_VARS" != "false" ]; then openssl aes-256-cbc -K $encrypted_95a52b3b9b3c_key -iv $encrypted_95a52b3b9b3c_iv -in id_rsa_downcloud_cozy_pass_web.enc -out id_rsa_downcloud_cozy_pass_web -d; fi
  - if [ "$TRAVIS_SECURE_ENV_VARS" != "false" ]; then eval "$(ssh-agent -s)"; fi
  - if [ "$TRAVIS_SECURE_ENV_VARS" != "false" ]; then chmod 600 id_rsa_downcloud_cozy_pass_web; fi
  - if [ "$TRAVIS_SECURE_ENV_VARS" != "false" ]; then ssh-add id_rsa_downcloud_cozy_pass_web; fi 
before_deploy:
  - yarn add cozy-app-publish
deploy:
  - provider: script
    skip_cleanup: true
    # deploy the build on downcloud and publish to the Cozy registry
    script: yarn cozyPublish
    on:
      branch: master
  - provider: script
    skip_cleanup: true
    # publish stable or beta versions using Github Releases (git tag)
    script: yarn cozyPublish
    on:
      tags: true